<html>
<head>
<script charset="utf-8" src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<link href='https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,700' rel='stylesheet' type='text/css'>
<style>
	body { font-family: 'Open Sans Condensed', 'sans-serif'; }
	svg { border: solid black 1px; }
	hearts {font-size: 20px; fill: "red";}
	button { padding: 15px; margin: 10px;
		font-family: 'Open Sans Condensed', 'sans-serif';
		font-weight:700;
		width: 130;
		color: white;
		text-transform: uppercase;
		letter-spacing: 2px;
		padding: 10px 20px;
		border-radius: 5px;
		font-size: 16px;
	}
	button.reset {
		background-color: #ff4d4d;
		border: solid red 1px;
	}
	button.income {
		background-color: #668cff;
		border: solid blue 1px;
	}
	button.edu {
		background-color: #ff8533;
		border: solid orange 1px;
	}
	button.children{
		background-color: #5cd65c;
		border: solid green 1px;
	}
	button.lgbt {
		background-color: #a64dff;
		border: #330066 1px;
	}
	text.posNumber {
		fill:  #00cca3;
		font-size: 50px;
		font-weight: 700;
	}
	text.posPercent {
		fill:  #00cca3;
		font-size: 50px;
		font-weight: 700;
	}
	text.negNumber {
		fill:  #4d194d;
		font-size: 50px;
		font-weight: 700;
	}
	text.negPercent {
		fill:  #4d194d;
		font-size: 50px;
		font-weight: 700;
	}
	text.posText {
		font-weight: 500;
		width: 100;
		height: 100;
	}
	.axis path { fill: none; stroke: #aaa;}
	.axis line { stroke: #aaa; }
	.axis text { fill: #aaa; font-size: .7em; }
	rect.bar { fill:  #b30000; opacity: .85}
	text.label {
		fill: #888;
		font-size: x-small;
		dominant-baseline: middle; 
		text-anchor: middle;
	}
	text.stateHeader{
		padding: 15px; margin: 10px;
		font-family: 'Open Sans Condensed', 'sans-serif';
		font-weight:700;
		font-size: 40px;
		letter-spacing: 2px;
		text-transform: uppercase;
		text-align: center;
	}
	text.topThree {
		font-size: 20px;
		fill: #404040;
		font-weight: 500;
	}
	text.histLabel{
		font-weight: 700;
		font-size: 20px;
		fill: #737373;
	}
	circle.rank {
		fill: red;
		stroke: red;
		opacity: 0.7
	}
	text.textRank {
		font-weight: 700;
		fill: white;
		font-size: 20px;
	}
	div.hoverLabel {   
		position: absolute;           
		text-align: center;           
		width: 90px;                  
		height: 50px;                 
		padding: 2px;             
		font: 12px sans-serif;        
		background: #aaa;   
		opacity: .7
		border: 0px;      
		border-radius: 5px;           
		pointer-events: none;         
	}
</style>
</head>

<body>
<h1>Online Dating</h1>
<p>Instructions: Select either 'Teens' or 'Adults' to learn about statistics involving the selected group and online dating habits </p>

<div style="display: inline-block; vertical-align:center; float:left; padding: 30px">
	<div><button class="reset" style="display: inline-block; " id="reset">Reset</button></div>
	<div><button class="income" style="display: inline-block;" id="income">Income</button></div>
	<div><button class="edu" style="display: inline-block; text-align:center" id="education">Education</button></div>
	<div><button class="children" style="display: inline-block;" id="children">Children</button></div>
	<div><button class="lgbt" style="display: inline-block;" id="lgbt">LGBT</button></div>
</div>
<div id="map" style="display: inline-block; position: absolute"></div>
<div id = "panel" style="left: 700; display: inline-block; position:relative; "></div>


<script>
// Initial state data - all hidden
var currStatePanel="#Alaska";
var svgMap = d3.select("#map").append("svg")
.attr("width",  700).attr("height", 500);
var svgPanel = d3.select("#panel").append("svg")
.attr("width",  0).attr("height", 500)
.style("visibility","hidden")
.style("float", "left");
var div = d3.select("#map").append("div")   
.attr("class", "hoverLabel")               
.style("opacity", 0);
var filters = {
	NONE: -1,
	INCOME: 0,
	EDUCATION: 1,
	CHILDREN: 2,
	LGBT: 3
};
var currFilter = filters.NONE;
// Geographic map setup
var projection = d3.geo.albersUsa().scale(860).translate([370, 250]);
var path = d3.geo.path().projection(projection);
// Data collection variables
var stateData = {};
var userData = {};
var stateNames = [];
var states = {};

// Formats for stats
var p0 = d3.format("%");
var sig2 = d3.format(".2r");
var formatIncome = d3.format("$,");

// Returns the corresponding online dating site when given a number
function numToSite(num){
	var site = ""
	switch(num){
		case(1):site="Match.com";break;
		case(2):site="eharmony";break;
		case(3):site="OK Cupid";break;
		case(4):site="Plenty of Fish";break;
		case(5):site="Christian Mingle";break;
		case(6):site="True.com";break;
		case(7):site="Zoosk";break;
		case(8):site="J Date";break;
		case(9):site="Date Hookup";break;
		case(10):site="Ashley Madison";break;
		case(11):site="Facebook";break;
		case(12):site="Twitter";break;
		case(13):site="Adult Friend Finder";break;
		case(14):site="Blackplanet";break;
		case(15):site="Chemistry.com";break;
		case(16):site="Craigslist";break;
		default:site="Other";break;
	}
	return site;
}
// Returns all the online dating sites mentioned in person's response.
// Note: no user responded with more than 5 sites.
function getSites(person){
	var sites=[];
	for (var i = 1; i < 5; i++){
		sites.push(numToSite(person["date1bm"+i]));
	}
	return sites;
}
// Returns the number of children in person's response.
function getChildren(person){
	if (Number(person.qd2b1)!=98&&Number(person.qd2b1)!=99&&
		Number(person.qd2b2)!=98&&Number(person.qd2b2)!=99&&
		Number(person.qd2c)!=98&&Number(person.qd2c)!=99) {
		var sum = 0;
		if(person.qd2b1){sum+=Number(person.qd2b1);}
		if(person.qd2b2){sum+=Number(person.qd2b2);}
		if(person.qd2c){sum+=Number(person.qd2c);}
		return sum;
	} else {
	 	return null;	
	}
}

//Returns the average of the person's income range
function getIncome(person){
	if(person.inc==1){return 5000;}
	else if(person.inc==2){return 15000;}
	else if(person.inc==3){return 25000;}
	else if(person.inc==4){return 35000;}
	else if(person.inc==5){return 45000;}
	else if(person.inc==6){return 62500;}
	else if(person.inc==7){return 87500;}
	else if(person.inc==8){return 125000;}
	else{return 175000;}
}

// Load all the state data
d3.csv("education.csv", function (error, edStates) {
	d3.csv("children.csv", function (error, childStates) {
		d3.csv("income.csv", function (error, incomeStates) {
			d3.csv("lgbt.csv", function (error, lgbtStates) {
				d3.json("id_to_state.json", function (error, stateIds) {
					d3.csv("adult_dating.csv", function (error, adultData){
						d3.json("id_to_state.json", function (error, stateIds) {
							d3.json("us.json", function(error, shapes) {
						
						// Store income data by state and initalize all object fields
						incomeStates.forEach(function (state) {
							stateData[state.State] = {
								// FIPS: "",
								income: state.Income,
								children: 0.0,
								education: {
									lessThanHS: 0.0,
									HSDiploma: 0.0,
									someCollege: 0.0,
									bachelorsPlus: 0.0
								},
								lgbt: 0.0,
							};
							stateNames.push(state.State);
							// Initialize all user fields
							userData[state.State] = {
								userList: [],
								income: 0,
								children: 0.0,
								education: {
									lessThanHS: 0.0,
									HSDiploma: 0.0,
									someCollege: 0.0,
									bachelorsPlus: 0.0
								},
								lgbt: 0.0,
								topSites: [],
								metPercentage: 0,
								breakupPercentage: 0,
							};
						});

						// Store children data by state
						childStates.forEach(function (state) {
							stateData[state.State].children = state.Avg_per_family;
						});

						// Store education attainment data by state
						edStates.forEach(function (location) {
							if (stateNames.indexOf(location["Area name"]) > -1) {
								stateData[location["Area name"]].education = {
									lessThanHS: location["Percent of adults with less than a high school diploma, 2010-2014"]/100,
									HSDiploma: location["Percent of adults with a high school diploma only, 2010-2014"]/100,
									someCollege: location["Percent of adults completing some college or associate's degree, 2010-2014"]/100,
									bachelorsPlus: location["Percent of adults with a bachelor's degree or higher, 2010-2014"]/100
								};
								// stateData[location["Area name"]].FIPS = location["FIPS Code"];
							}
						});

						// Store LGBT presence by state
						lgbtStates.forEach(function (state) {
							stateData[state.State].lgbt = state.Yes/100;
						});	

						// Store data for online dating users
						adultData.forEach(function (user) {
							var state = stateIds[user.state]["state"];
							var singleUserData = {
								sites:getSites(user),
								income:getIncome(user),
								numberOfChildren:getChildren(user),
								educationLevel:{
									lessThanHS: user.educ2==1||user.educ2==2,
									HSDiploma: user.educ2==3,
									someCollege: user.educ2 == 4 || user.educ2 == 5,
									bachelorsPlus: user.educ2 == 6 || user.educ2 == 7 || user.educ2 == 8
								},
								lgbt: user.lgbt==2 || user.lgbt==3 || user.lgbt == 4,
								metPartnerOnline: user.rel1 == 1,
								electronicBreakup: user.breaka==1||user.breakb==1
							};
							userData[state].userList.push(singleUserData);
						});

						// Calculate user stats
						for(var state in userData){
							var metOnline = 0;
							var eBreakup = 0;
							var i;
							var s=userData[state];
							for(i=0;i<s.userList.length;i++){
								if(s.userList[i].metPartnerOnline){metOnline++;}
								if(s.userList[i].electronicBreakup){eBreakup++;}
							}
							var percentMet = (metOnline/i);
							var percentBroken = (eBreakup/i);
							userData[state].metPercentage = percentMet;
							userData[state].breakupPercentage = percentBroken;

							// Calculate median income
							userData[state].income = d3.median(userData[state].userList, function (user) {
								return user.income;
							});

							// Calculate the mean number of children per household
							userData[state].children = d3.mean(userData[state].userList, function (user) {
								return user.numberOfChildren;
							});

							// Calculate the percentages of education attainment for users
							userData[state].education = {
								lessThanHS: d3.sum(userData[state].userList, function (user) {
									return user.educationLevel.lessThanHS;
								}) / userData[state].userList.length,
								HSDiploma: d3.sum(userData[state].userList, function (user) {
									return user.educationLevel.HSDiploma;
								}) / userData[state].userList.length,
								someCollege: d3.sum(userData[state].userList, function (user) {
									return user.educationLevel.someCollege;
								}) / userData[state].userList.length,
								bachelorsPlus: d3.sum(userData[state].userList, function (user) {
									return user.educationLevel.bachelorsPlus;
								}) / userData[state].userList.length,
							};

							// Calculate the percentage of users who identify as LGBT
							userData[state].lgbt = d3.sum(userData[state].userList, function (user) {
								return user.lgbt;
							}) / userData[state].userList.length;

							// Calculate the top 3 sites:
							// 1. Collect all the sites for every user in the state
							var allSitesFlat = [];
							userData[state].userList.forEach(function (user) {
								allSitesFlat = allSitesFlat.concat(user.sites);
							});
							// 2. Count up the frequency for each site
							var siteCounts = {};
							var siteCountsList = [];
							allSitesFlat.forEach(function (site) {
								if (siteCounts[site]) {
									siteCounts[site] += 1;
								} else {
									siteCounts[site] = 1;
								}
							});
							for (var key in siteCounts) { siteCountsList.push( { name: key, count: siteCounts.key } ); };
							// 3. Compute the top 3 via pairwise comparisons
							siteCountsList.sort(function (a, b) {
								return b.count - a.count;
							});
							// 4. Store the result in userData
							userData[state].sites = siteCountsList.slice(0, 3).map(function (siteObj) { return siteObj.name; });

							// Update the detail pane
							var svg = d3.select("#" + state.replace(" ", ""));

							//Positive Fact
							svg.append("text").html(p0(userData[state].metPercentage))
							   .attr("x", 30).attr("y", 330).attr("class", "posNumber");
							svg.append("text").html("met a significant other online")
							   .attr("x", 120).attr("y", 325).attr("class", "posText");

							//Negative Fact
							svg.append("text").html(p0(userData[state].breakupPercentage))
							   .attr("x", 30).attr("y", 400).attr("class", "negNumber");
							svg.append("text").html("have broken up with their partner by changing their status to single")
							   .attr("x", 120).attr("y", 400).attr("class", "negText");
						}

							
						//Load Map
						states = topojson.feature(shapes, shapes.objects.states).features;
						var statePaths = svgMap.append("g");
						var tempStates=statePaths.selectAll("path").data(states).enter()
						.append("path").attr("d", path)
						.style("fill", "red").style("stroke", "#ccc").style("fill-opacity", "0.7")
						.on('click', function(d, i) {
							var stateName = stateIds[d.id]["state"];
							var id = "#" + stateName.replace(" ", "");
							var svg = d3.select(id).style("visibility", "visible");
				           	// Only make the panel hidden if a different state is clicked
				           	if (id != currStatePanel) {
				           		d3.select(currStatePanel).style("visibility", "hidden");
				           		currStatePanel = id;
				           	}
				        })
						.on('mouseover', function(d, i) {
							var currentState = this;
							var stateAbbrev = stateIds[d.id]["abbrev"];
							d3.select(this).style('fill-opacity', 1);
							div.transition()        
							.duration(200)      
							.style("opacity", .9);
							var stateName = stateIds[d.id]["state"];
							var inner = "";
							switch (currFilter) {
								case (filters.INCOME):
									inner = stateAbbrev + ": " + formatIncome(stateData[stateName].income) +
											"<br>" +
									        "Users: " + formatIncome(userData[stateName].income);
									break;
								case (filters.EDUCATION):
									inner = stateAbbrev + ": " + p0(stateData[stateName].education.someCollege) +
											"<br>" +
											"Users: " + p0(userData[stateName].education.someCollege);
									break;
								case (filters.CHILDREN):
									inner = stateAbbrev + ": " + sig2(stateData[stateName].children) +
											"<br>" +
											"Users: " + sig2(userData[stateName].children);
									break;
								case (filters.LGBT):
									inner = stateAbbrev + ": " + p0(stateData[stateName].lgbt) +
											"<br>" +
											"Users: " + p0(userData[stateName].lgbt);
									break;
								default:
									inner = 28 + "% of " + stateAbbrev + " residents use online dating.";
									break;
							}
							div.html(inner)
							.style("left", (d3.event.pageX-210) + "px")     
							.style("top", (d3.event.pageY - 120) + "px");  
						})
						.on('mouseout', function(d, i) {
							d3.selectAll('path').style({'fill-opacity':.7});
							div.transition()        
							.duration(500)      
							.style("opacity", 0);
						});

						//Chlorlpleth scaling
						//Income Scale: 
						var maxIncome = 0;
						var minIncome = 1000000000000;
						for(state in stateData){
							var currDiff = Math.abs(stateData[state].income - userData[state].income);
							if (currDiff > maxIncome) 	maxIncome = currDiff;
							if (currDiff < minIncome)	minIncome = currDiff;
						}
						var incomeScale = d3.scale.linear().domain([minIncome, maxIncome]).range(["#ccd9ff", "#0040ff"]);

						//Buttons
						//Income Button
						d3.select("#income").on("click", function (d) {
							currFilter = filters.INCOME;
							tempStates.style("fill", function (state) {
										if (state.id>56) return "#000";
										var stateName = stateIds[state.id]["state"];
										var incomeValue = Math.abs(stateData[stateName].income-userData[stateName].income);
										return incomeScale(incomeValue);
							});
						});
					});
				});
			});
		});
	});
});
});
});

// Set up the map and panel
d3.json("id_to_state.json", function (error, stateIds) {
	d3.json("us.json", function(error, shapes) {
		for (var id in stateIds) {
			var stateName = stateIds[id]["state"];
			// Ids cannot have spaces
			var id = stateName.replace(" ", "");
			var svg = d3.select("#panel").append("svg")
			.attr("width", 300).attr("height", 500)
			.style("visibility","hidden")
			.style("position", "absolute")
			.attr("id", id);

			//Histogram temp/mock data:
			var samplePercentages = [60, 21, 12];
			var sampleSites = /*userData[stateName].sites;*/["Facebook", "eHarmony", "Match.com"];

			//Histogram
			svg.append("text").text(stateName).attr("x", 50).attr("y", 50).attr("class", "stateHeader");
			var hist = svg.append("svg").attr("width", 250).attr("height", 250).attr("x", 20).attr("y", 80);
			hist.append("text").text("Top 3 Online Dating Sites").attr("x", 30).attr("y", 15).attr("class", "topThree");

			var xScale = d3.scale.linear().domain([0, 100]).range([20, 180]);
			var yCoor = 55;
			for (var s=0; s<3; s++){
				hist.append("rect").attr("class", "bar")
					.attr("y", yCoor)
					.attr("x", 200 - xScale(samplePercentages[s]))
					.attr("height", 35)
					.attr("width", (xScale(samplePercentages[s])));
				hist.append("text").attr("class", "histLabel").attr("y", yCoor+25).attr("x", 30).text(sampleSites[s]);
				hist.append("circle").attr("cx", 220).attr("cy", yCoor+15).attr("r", 15).attr("class", "rank");
				hist.append("text").attr("x", 210).attr("y", yCoor+20).text(s+1).attr("class", "textRank");
				yCoor += 50;
			}
		}
	});
});
d3.select("#reset").on("click", function(d) {
	currFilter = filters.NONE;
});
d3.select("#income").on("click", function (d) {
	currFilter = filters.INCOME;
});
d3.select("#education").on("click", function (d) {
	currFilter = filters.EDUCATION;
});
d3.select("#children").on("click", function (d) {
	currFilter = filters.CHILDREN;
});
d3.select("#lgbt").on("click", function (d) {
	currFilter = filters.LGBT;
});
</script>
</body>

</html>
